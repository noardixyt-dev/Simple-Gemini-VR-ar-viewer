<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>6DoF Stereo Passthrough</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #ui { position: fixed; inset: 0; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; color: #00e5ff; }
        .btn { background: #00e5ff; color: #000; padding: 20px 40px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; margin: 10px; }
        #file-input { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>STEREO 6DoF ENGINE</h1>
        <label style="border: 2px dashed #00e5ff; padding: 20px; border-radius: 10px; cursor: pointer;">
            <span>üìÅ IMPORT .GLB MODEL</span>
            <input type="file" id="file-input" accept=".glb,.gltf">
        </label>
        <button class="btn" onclick="initEngine()">ACTIVATE HEADSET MODE</button>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false">
        <a-assets>
            <a-asset-item id="default-model" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf"></a-asset-item>
        </a-assets>

        <a-entity id="ar-model" gltf-model="#default-model" position="0 1.2 -2" scale="0.5 0.5 0.5"></a-entity>

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" position="1 2 1" intensity="1"></a-light>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls="pointerLockEnabled: true"></a-camera>
        </a-entity>
    </a-scene>

    <script>
        const modelEl = document.querySelector('#ar-model');
        const fileInput = document.querySelector('#file-input');

        // Handle File Loading
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                modelEl.setAttribute('gltf-model', `url(${url})`);
            }
        });

        async function initEngine() {
            // 1. Request Sensors
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                await DeviceOrientationEvent.requestPermission();
            }

            try {
                // 2. Start Camera Passthrough
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: 1280, height: 720 } 
                });
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                // 3. Create the Stereo Background
                // We map the video to the scene background which A-Frame handles stereoscopically in VR mode
                const scene = document.querySelector('a-scene');
                const texture = new THREE.VideoTexture(video);
                scene.object3D.background = texture;

                // 4. Enter VR Mode for SBS view
                document.getElementById('ui').style.display = 'none';
                scene.enterVR();

            } catch (err) {
                alert("Ensure HTTPS is used. Error: " + err.message);
            }
        }
    </script>
</body>
</html>

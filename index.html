<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Stereo 6DoF Tracker</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00e5ff; font-family: sans-serif; }
        #ui { position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        .btn { background: #00e5ff; color: #000; border: none; padding: 20px 50px; border-radius: 50px; font-weight: bold; cursor: pointer; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>6DoF STEREO AR</h1>
        <label style="border: 2px dashed #00e5ff; padding: 20px; border-radius: 10px; cursor: pointer; margin-bottom: 20px;">
            <span>üìÅ UPLOAD .GLB</span>
            <input type="file" id="file-upload" accept=".glb,.gltf">
        </label>
        <button class="btn" onclick="startAR()">START ENGINE</button>
    </div>

    <a-scene 
        webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay;" 
        embedded 
        vr-mode-ui="enabled: false">
        
        <a-assets id="assets"></a-assets>

        <a-entity id="reticle" visible="false">
            <a-ring color="#00e5ff" rotation="-90 0 0" radius-inner="0.1" radius-outer="0.15"></a-ring>
        </a-entity>

        <a-entity id="target-object" visible="false" scale="0.5 0.5 0.5"></a-entity>

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" position="1 2 1"></a-light>
    </a-scene>

    <script>
        const model = document.querySelector('#target-object');
        const reticle = document.querySelector('#reticle');
        const fileInput = document.querySelector('#file-upload');
        let hitTestResults = null;

        // 1. File Upload Logic
        fileInput.addEventListener('change', (e) => {
            const url = URL.createObjectURL(e.target.files[0]);
            model.setAttribute('gltf-model', `url(${url})`);
        });

        async function startAR() {
            const scene = document.querySelector('a-scene');
            
            // 2. Camera Passthrough
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const video = document.createElement('video');
            video.srcObject = stream;
            video.play();
            
            // Apply camera to background for stereo passthrough
            const texture = new THREE.VideoTexture(video);
            scene.object3D.background = texture;

            document.getElementById('ui').style.display = 'none';
            scene.enterVR(); // Switches to Side-by-Side view
        }

        // 3. 6DoF Hit-Testing (The "Pinned to Ground" Math)
        document.querySelector('a-scene').addEventListener('render-target-loaded', () => {
            const renderer = document.querySelector('a-scene').renderer;
            renderer.xr.addEventListener('sessionstart', () => {
                const session = renderer.xr.getSession();
                session.requestReferenceSpace('viewer').then((space) => {
                    session.requestHitTestSource({ space }).then((source) => {
                        window.hitTestSource = source;
                    });
                });
            });
        });

        // Frame loop to update reticle and object position
        document.querySelector('a-scene').addEventListener('tick', () => {
            const frame = document.querySelector('a-scene').frame;
            if (frame && window.hitTestSource) {
                const results = frame.getHitTestResults(window.hitTestSource);
                if (results.length > 0) {
                    const hit = results[0];
                    const pose = hit.getPose(document.querySelector('a-scene').renderer.xr.getReferenceSpace());
                    reticle.setAttribute('position', pose.transform.position);
                    reticle.setAttribute('visible', true);
                    
                    // Tap to place (simplified for this demo)
                    window.addEventListener('click', () => {
                        model.setAttribute('position', pose.transform.position);
                        model.setAttribute('visible', true);
                    }, { once: true });
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Stereo 6DoF Fixed</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #ui { position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; color: #00e5ff; }
        .btn { background: #00e5ff; color: #000; border: none; padding: 20px 50px; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #file-input { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h2>STEREO 6DoF SYSTEM</h2>
        <label style="border: 2px dashed #00e5ff; padding: 20px; border-radius: 10px; cursor: pointer;">
            <span>üìÅ LOAD MODEL (.GLB)</span>
            <input type="file" id="file-input" accept=".glb,.gltf">
        </label>
        <button class="btn" onclick="startEngine()">ENGAGE STEREO AR</button>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false">
        <a-assets></a-assets>

        <a-entity id="ar-model" visible="false" scale="0.5 0.5 0.5"></a-entity>

        <a-light type="ambient" intensity="1.5"></a-light>
        <a-light type="directional" position="1 2 1"></a-light>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera id="cam" look-controls="pointerLockEnabled: true"></a-camera>
        </a-entity>
    </a-scene>

    <script>
        const modelEl = document.querySelector('#ar-model');
        const fileInput = document.querySelector('#file-input');

        fileInput.addEventListener('change', (e) => {
            const url = URL.createObjectURL(e.target.files[0]);
            modelEl.setAttribute('gltf-model', `url(${url})`);
            modelEl.setAttribute('visible', 'true');
        });

        async function startEngine() {
            // 1. Permission (iOS/Android)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                await DeviceOrientationEvent.requestPermission();
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} } 
                });

                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                const scene = document.querySelector('a-scene');
                const texture = new THREE.VideoTexture(video);
                
                // ASPECT RATIO FIX: 
                // We force the texture to "Cover" the background instead of "Fit"
                // This prevents the stretching you were seeing.
                texture.matrixAutoUpdate = false;
                const aspect = 1280 / 720;
                const screenAspect = (window.innerWidth / 2) / window.innerHeight;
                if (aspect > screenAspect) {
                    texture.matrix.setUvTransform(0, 0, screenAspect / aspect, 1, 0, 0.5, 0.5);
                } else {
                    texture.matrix.setUvTransform(0, 0, 1, aspect / screenAspect, 0, 0.5, 0.5);
                }

                scene.object3D.background = texture;

                // 2. Hide UI and Enter Side-by-Side Mode
                document.getElementById('ui').style.display = 'none';
                
                // Force 6DoF: A-Frame's enterVR handles the SBS split and Gyro
                scene.enterVR();

                // If no model was uploaded, show a placeholder box so you can see tracking works
                if (!modelEl.getAttribute('gltf-model')) {
                    modelEl.setAttribute('geometry', 'primitive: box');
                    modelEl.setAttribute('material', 'color: red');
                    modelEl.setAttribute('visible', 'true');
                }

            } catch (err) {
                alert("Please use HTTPS. Error: " + err.message);
            }
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stereo AR VIO</title>
    <script src="https://cdn.jsdelivr.net/gh/alanross/AlvaAR@master/dist/alva_ar.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; color: #00e5ff; }
        #three-canvas { position: absolute; inset: 0; z-index: 10; }
        #ui { position: absolute; inset: 0; z-index: 100; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn { background: #00e5ff; color: #000; padding: 20px 50px; border-radius: 50px; font-weight: bold; cursor: pointer; border: none; font-size: 1.3rem; }
        #rotate-overlay { position: fixed; inset: 0; z-index: 9999; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        @media (orientation: portrait) { #rotate-overlay { display: flex; } }
        .progress-bar { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: #00e5ff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="rotate-overlay"><h2>ROTATE TO LANDSCAPE</h2></div>
    <canvas id="three-canvas"></canvas>
    
    <div id="ui">
        <h1>VIO STEREO AR</h1>
        <p id="msg">Initializing Engine...</p>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <br>
        <button class="btn" id="startBtn" style="display:none;">START ENGINE</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let alva, scene, bgScene, renderer, video, cameraL, cameraR, bgCamera;
        let trackCanvas, trackCtx, videoTexture;
        let deviceRot = new THREE.Quaternion();
        const IPD = 0.064;

        // 1. Wait for everything to load before showing the button
        const checkReady = setInterval(() => {
            if (typeof AlvaAR !== 'undefined') {
                clearInterval(checkReady);
                document.getElementById('progress-fill').style.width = "100%";
                document.getElementById('msg').innerText = "System Ready. Host must be HTTPS.";
                document.getElementById('startBtn').style.display = "block";
            }
        }, 500);

        async function init() {
            document.getElementById('msg').innerText = "Requesting Access...";
            
            try {
                // A. CAMERA
                video = document.createElement('video');
                video.autoplay = video.muted = video.playsInline = true;
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                video.srcObject = stream;
                await video.play();

                // B. SENSORS (Critical for "Awaiting Permission" issue)
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') {
                        document.getElementById('msg').innerText = "Sensor Permission Denied!";
                        return;
                    }
                }

                // C. ORIENTATION LISTENER
                window.addEventListener('deviceorientation', (e) => {
                    const alpha = THREE.MathUtils.degToRad(e.alpha);
                    const beta = THREE.MathUtils.degToRad(e.beta);
                    const gamma = THREE.MathUtils.degToRad(e.gamma);
                    const orient = window.orientation ? THREE.MathUtils.degToRad(window.orientation) : 0;
                    const euler = new THREE.Euler(beta, alpha, -gamma, 'YXZ');
                    deviceRot.setFromEuler(euler);
                    deviceRot.multiply(new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1), -orient));
                });

                // D. SLAM ENGINE
                trackCanvas = document.createElement('canvas');
                trackCanvas.width = 1280; trackCanvas.height = 720;
                trackCtx = trackCanvas.getContext('2d');
                alva = await AlvaAR.Initialize(1280, 720);

                setupThree();
                document.getElementById('ui').style.display = 'none';
                animate();
            } catch (err) {
                document.getElementById('msg').innerText = "Error: " + err.message;
            }
        }

        function setupThree() {
            const canvas = document.getElementById('three-canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.autoClear = false;

            bgScene = new THREE.Scene();
            bgCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            videoTexture = new THREE.VideoTexture(video);
            bgScene.add(new THREE.Mesh(new THREE.PlaneGeometry(2, 2), new THREE.MeshBasicMaterial({ map: videoTexture, depthTest: false })));

            scene = new THREE.Scene();
            const aspect = (window.innerWidth / 2) / window.innerHeight;
            cameraL = new THREE.PerspectiveCamera(70, aspect, 0.01, 100);
            cameraR = new THREE.PerspectiveCamera(70, aspect, 0.01, 100);

            scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 4));
            new GLTFLoader().load('https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf', (g) => {
                g.scene.position.set(0, -0.5, -2);
                scene.add(g.scene);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            trackCtx.drawImage(video, 0, 0, 1280, 720);
            const pose = alva.findCameraPose(trackCanvas);

            if (pose) {
                const mat = new THREE.Matrix4().fromArray(pose);
                const pos = new THREE.Vector3().setFromMatrixPosition(mat);
                cameraL.position.copy(pos); cameraL.quaternion.copy(deviceRot); cameraL.translateX(-IPD/2);
                cameraR.position.copy(pos); cameraR.quaternion.copy(deviceRot); cameraR.translateX(IPD/2);
            }

            const w = window.innerWidth, h = window.innerHeight;
            renderer.clear();
            renderer.setViewport(0, 0, w / 2, h);
            renderer.render(bgScene, bgCamera); renderer.render(scene, cameraL);
            renderer.setViewport(w / 2, 0, w / 2, h);
            renderer.render(bgScene, bgCamera); renderer.render(scene, cameraR);
        }

        document.getElementById('startBtn').onclick = init;
    </script>
</body>
</html>
w
